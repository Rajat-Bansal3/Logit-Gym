generator client {
  provider = "prisma-client"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  OWNER
  TRAINER
  MEMBER
}

enum MemberStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum PaymentStatus {
  PAID
  PENDING
  OVERDUE
  FAILED
  SUCCESS
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  BANK_TRANSFER
}

enum CheckInType {
  IN
  OUT
}

enum MembershipPlanType {
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  role      UserRole
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  member Member?
  gym    Gym[]

  @@index([email])
  @@index([role])
  @@map("users")
}

model Gym {
  id        String   @id @default(cuid())
  name      String
  address   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  isDeleted Boolean  @default(false)

  ownerId String
  owner   User   @relation(fields: [ownerId], references: [id])

  gymProfile       GymProfile?
  members          Member[]
  attendanceLogs   AttendanceLog[]
  transactions     Transaction[]
  payments         Payment[]
  weeklyActivities WeeklyActivity[]
  hourlyTraffic    HourlyTraffic[]
  gymReports       GymReport[]
  gymMetrics       GymMetrics?

  @@map("gyms")
}

model Member {
  id     String  @id @default(cuid())
  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  gymId String
  gym   Gym    @relation(fields: [gymId], references: [id])

  name        String
  dateOfBirth DateTime
  address     String
  phone       String   @unique
  email       String?  @unique
  avatarUrl   String?
  gender      String

  emergencyContact String?

  weight     Float?
  height     Float?
  age        Int?
  bloodGroup String?

  status MemberStatus @default(ACTIVE)

  joinDate  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  membershipHistory Membership[] @relation("MemberToHistory")

  currentMembershipId String?     @unique
  currentMembership   Membership? @relation("CurrentMemberPlan", fields: [currentMembershipId], references: [id])

  attendanceLogs   AttendanceLog[]
  transactions     Transaction[]
  payments         Payment[]
  weeklyActivities WeeklyActivity[]
  memberMetrics    MemberMetrics?

  @@index([gymId])
  @@index([status])
  @@index([joinDate])
  @@index([email])
  @@index([phone])
  @@map("members")
}

model Membership {
  id       String @id @default(cuid())
  memberId String

  member Member @relation("MemberToHistory", fields: [memberId], references: [id], onDelete: Cascade)

  planType  MembershipPlanType
  startDate DateTime
  endDate   DateTime?
  isActive  Boolean            @default(true)

  planName  String?
  dueAmount Float   @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  successorId String?     @unique
  successor   Membership? @relation("MembershipRenewal", fields: [successorId], references: [id])
  predecessor Membership? @relation("MembershipRenewal")

  payments Payment[]

  currentForMember Member? @relation("CurrentMemberPlan")

  @@unique([memberId, startDate])
  @@index([memberId])
  @@index([endDate])
  @@index([isActive])
  @@map("memberships")
}

model AttendanceLog {
  id        String      @id @default(cuid())
  memberId  String
  member    Member      @relation(fields: [memberId], references: [id], onDelete: Cascade)
  gymId     String
  gym       Gym         @relation(fields: [gymId], references: [id], onDelete: Cascade)
  type      CheckInType
  timestamp DateTime    @default(now())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@index([memberId])
  @@index([gymId])
  @@index([timestamp])
  @@index([memberId, timestamp])
  @@map("attendance_logs")
}

model Transaction {
  id          String          @id @default(cuid())
  memberId    String
  member      Member          @relation(fields: [memberId], references: [id], onDelete: Restrict)
  gymId       String
  gym         Gym             @relation(fields: [gymId], references: [id], onDelete: Restrict)
  amount      Float
  date        DateTime        @default(now())
  type        TransactionType
  method      PaymentMethod
  description String?
  status      PaymentStatus   @default(SUCCESS)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  payment Payment?

  @@index([memberId])
  @@index([gymId])
  @@index([date])
  @@index([type])
  @@index([status])
  @@map("transactions")
}

model Payment {
  id           String        @id @default(cuid())
  memberId     String
  member       Member        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  membershipId String
  membership   Membership    @relation(fields: [membershipId], references: [id], onDelete: Cascade)
  gymId        String
  gym          Gym           @relation(fields: [gymId], references: [id], onDelete: Cascade)
  amount       Float
  dueDate      DateTime?
  paidDate     DateTime?
  description  String?
  status       PaymentStatus @default(PENDING)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  transactionId String?      @unique
  transaction   Transaction? @relation(fields: [transactionId], references: [id])

  @@index([memberId])
  @@index([membershipId])
  @@index([gymId])
  @@index([status])
  @@index([dueDate])
  @@index([paidDate])
  @@map("payments")
}

model GymProfile {
  id    String @id @default(cuid())
  gymId String @unique
  gym   Gym    @relation(fields: [gymId], references: [id], onDelete: Cascade)

  bio           String?
  timing        String
  openDays      String[]
  fees          Float
  genderAllowed String

  ownerName         String
  ownerContact      String
  fitnessProfession String?

  rating       Float?   @default(0)
  totalReviews Int      @default(0)
  images       String[]
  amenities    String[]

  referralOffer String?
  referralCode  String? @unique
  referralUsed  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([gymId])
  @@map("gym_profiles")
}

model WeeklyActivity {
  id        String   @id @default(cuid())
  memberId  String
  member    Member   @relation(fields: [memberId], references: [id], onDelete: Cascade)
  gymId     String
  gym       Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  weekStart DateTime
  monday    Float    @default(0)
  tuesday   Float    @default(0)
  wednesday Float    @default(0)
  thursday  Float    @default(0)
  friday    Float    @default(0)
  saturday  Float    @default(0)
  sunday    Float    @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([memberId, weekStart])
  @@index([memberId])
  @@index([gymId])
  @@index([weekStart])
  @@map("weekly_activities")
}

model HourlyTraffic {
  id        String   @id @default(cuid())
  gymId     String
  gym       Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  date      DateTime
  hour      Int
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([gymId, date, hour])
  @@index([gymId])
  @@index([date, hour])
  @@index([gymId, date])
  @@map("hourly_traffic")
}

model GymReport {
  id               String   @id @default(cuid())
  gymId            String
  gym              Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  reportDate       DateTime @default(now())
  healthScore      Int
  healthVerdict    String
  monthlyRevenue   Float
  projectedRevenue Float
  activeMembers    Int
  churnRiskCount   Int
  aiInsights       String[]
  weeklyData       Float[]
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([gymId])
  @@index([reportDate])
  @@index([gymId, reportDate])
  @@map("gym_reports")
}

model GymMetrics {
  id               String   @id @default(cuid())
  gymId            String   @unique
  gym              Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  currentOccupancy Int      @default(0)
  totalRevenue     Float    @default(0)
  pendingDues      Float    @default(0)
  growthPercentage Float    @default(0)
  lastUpdated      DateTime @default(now())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([gymId])
  @@map("gym_metrics")
}

model MemberMetrics {
  id                   String        @id @default(cuid())
  memberId             String        @unique
  member               Member        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  attendancePercentage Float         @default(0)
  currentStreak        Int           @default(0)
  lastCheckIn          DateTime?
  totalCheckIns        Int           @default(0)
  paymentStatus        PaymentStatus @default(PENDING)
  lastUpdated          DateTime      @default(now())
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  @@index([memberId])
  @@index([paymentStatus])
  @@map("member_metrics")
}
